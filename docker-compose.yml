# AI-Powered Delivery Post Office Identification System
# Docker Compose Configuration

services:
  # DIGIPIN Backend API (Port 5000)
  # Temporarily commented due to port 5000 conflict with macOS ControlCenter
  # To use digipin: either change the port mapping below or disable ControlCenter's use of port 5000
  # Change port mapping to: "5001:5000" to run digipin on port 5001 instead
  digipin:
    build:
      context: ./digipin
      dockerfile: Dockerfile
    container_name: digipin-api
    ports:
      - "5001:5000"  # Changed to "5001:5000" to avoid conflict
    environment:
      - NODE_ENV=production
      - PORT=5001
    volumes:
      - ./digipin:/app
      - /app/node_modules
    restart: unless-stopped
    networks:
      - delivery-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/api/digipin/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ML Microservice (Port 8000)
  ml-service:
    build:
      context: ./ml
      dockerfile: Dockerfile
    container_name: ml-service
    ports:
      - "8000:8000"
    environment:
      - CSV_PATH=/data/all_india_pincode_directory_2025.csv
      - ML_PORT=8000
      - ML_HOST=0.0.0.0
      - DIGIPIN_API_URL=http://digipin:5001
      - MODEL_NAME=sentence-transformers/all-MiniLM-L6-v2
    volumes:
      - ./ml:/app
      - ./post:/data:ro  # Mount data directory as read-only
      - ml-models-cache:/root/.cache  # Cache for ML models
      - ml-faiss-cache:/app/cache  # Cache for FAISS index and metadata
    restart: unless-stopped
    networks:
      - delivery-network
    # depends_on:
    #   - digipin  # Commented due to digipin port conflict
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import requests; requests.get(\"http://localhost:8000/health\")'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s  # ML models need time to load

  # Backend API (Port 3001)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend-api
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - HOST=0.0.0.0
      - DIGIPIN_API_URL=http://digipin:5001
      - ML_API_URL=http://ml-service:8000
      - CSV_PATH=/data/all_india_pincode_directory_2025.csv
      - CORS_ORIGIN=http://localhost:5173
      - RATE_LIMIT_WINDOW_MS=900000
      - RATE_LIMIT_MAX_REQUESTS=100
      - MAX_FILE_SIZE=10485760
      - BATCH_CHUNK_SIZE=10
    volumes:
      - ./post:/data:ro
      - backend-uploads:/app/uploads
      - backend-logs:/app/logs
    restart: unless-stopped
    networks:
      - delivery-network
    depends_on:
      # - digipin  # Commented due to digipin port conflict
      - ml-service
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3001/api/health/live', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Frontend (Port 5173)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Build-time variables only - NO SECRETS HERE
        - VITE_API_URL=http://localhost:3001
        - VITE_DIGIPIN_API_URL=http://localhost:5001
        - VITE_ML_API_URL=http://localhost:8000
        - VITE_GOOGLE_CLIENT_ID=372975400843-ffr7c5j59nmga7tk2nbog6o5mjpgq11s.apps.googleusercontent.com
    container_name: frontend-app
    ports:
      - "5173:80"  # Map container port 80 to host 5173
    environment:
      - NODE_ENV=production
    restart: unless-stopped
    networks:
      - delivery-network
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  delivery-network:
    driver: bridge
    name: delivery-network

volumes:
  ml-models-cache:
    name: ml-models-cache
    driver: local
  ml-faiss-cache:
    name: ml-faiss-cache
    driver: local
  backend-uploads:
    name: backend-uploads
    driver: local
  backend-logs:
    name: backend-logs
    driver: local
